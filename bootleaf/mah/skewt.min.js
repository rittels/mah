/*
 * SkewT v1.1.0
 * 2016 David Felix - dfelix@live.com.pt
 * Dependency:
 * d3.v3.min.js from https://d3js.org/
 */
var SkewT=function(a){function D(){c=parseInt(b.style("width"),10)-10,d=c,p=c-e.left-e.right,q=c-e.top-e.bottom,r=d3.scale.linear().range([0,p]).domain([-45,50]),s=d3.scale.log().range([0,q]).domain([i,h]),t=d3.svg.axis().scale(r).tickSize(0,0).ticks(10).orient("bottom"),u=d3.svg.axis().scale(s).tickSize(0,0).tickValues(j).tickFormat(d3.format(".0d")).orient("left"),v=d3.svg.axis().scale(s).tickSize(5,0).tickValues(k).orient("right")}function E(a,b){switch(b){case"kt":return 1.943844492*a;case"kmh":return 3.6*a;default:return a}}function F(){A.selectAll("*").remove(),D(),y.attr("width",p+e.right+e.left).attr("height",q+e.top+e.bottom),z.attr("transform","translate("+e.left+","+e.top+")"),G(),H(),J(w)}var p,q,r,s,t,u,v,b=d3.select(a),c=parseInt(b.style("width"),10),d=c,e={top:30,right:40,bottom:20,left:35},f=Math.PI/180,g=Math.tan(55*f),h=1050,i=100,j=[1e3,850,700,500,300,200,100],k=[950,900,800,750,650,600,550,450,400,350,250,150],l=25,o=(d3.scale.linear().range([0,300]).domain([0,150]),d3.scale.linear(),d3.bisector(function(a){return a.press}).left),w=[],x="kt",y=b.append("svg").attr("id","svg"),z=y.append("g").attr("id","container"),A=z.append("g").attr("id","skewtbg").attr("class","skewtbg"),B=z.append("g").attr("class","skewt"),C=z.append("g").attr("class","windbarb");d3.select(window).on("resize",F);var G=function(){A.append("clipPath").attr("id","clipper").append("rect").attr("x",0).attr("y",0).attr("width",p).attr("height",q),A.selectAll("templine").data(d3.range(-100,45,10)).enter().append("line").attr("x1",function(a){return r(a)-.5+(s(h)-s(100))/g}).attr("x2",function(a){return r(a)-.5}).attr("y1",0).attr("y2",q).attr("class",function(a){return 0==a?"tempzero":"gridline"}).attr("clip-path","url(#clipper)"),A.selectAll("pressureline").data(j).enter().append("line").attr("x1",0).attr("x2",p).attr("y1",function(a){return s(a)}).attr("y2",function(a){return s(a)}).attr("class","gridline");for(var a=d3.range(i,h+1,10),b=d3.range(-30,240,20),c=[],d=0;d<b.length;d++){for(var e=[],f=0;f<a.length;f++)e.push(b[d]);c.push(e)}var k=d3.svg.line().interpolate("linear").x(function(b,c){return r((273.15+b)/Math.pow(1e3/a[c],.286)-273.15)+(s(h)-s(a[c]))/g}).y(function(b,c){return s(a[c])});A.selectAll("dryadiabatline").data(c).enter().append("path").attr("class","gridline").attr("clip-path","url(#clipper)").attr("d",k),A.append("line").attr("x1",p-.5).attr("x2",p-.5).attr("y1",0).attr("y2",q).attr("class","gridline"),A.append("g").attr("class","x axis").attr("transform","translate(0,"+(q-.5)+")").call(t),A.append("g").attr("class","y axis").attr("transform","translate(-0.5,0)").call(u),A.append("g").attr("class","y axis ticks").attr("transform","translate(-0.5,0)").call(v)},H=function(){var a=d3.range(5,105,5),b=z.append("defs");a.forEach(function(a){var c=b.append("g").attr("id","barb"+a),d=Math.floor(a/50),e=Math.floor((a-50*d)/10),f=Math.floor((a-50*d-10*e)/5),g=l;c.append("line").attr("x1",0).attr("x2",0).attr("y1",0).attr("y2",l);for(var h=0;h<d;h++)c.append("polyline").attr("points","0,"+g+" -10,"+g+" 0,"+(g-4)).attr("class","flag"),g-=7;for(h=0;h<e;h++)c.append("line").attr("x1",0).attr("x2",-10).attr("y1",g).attr("y2",g+4),g-=3;for(h=0;h<f;h++)c.append("line").attr("x1",0).attr("x2",-5).attr("y1",g).attr("y2",g+2),g-=3})},I=function(a){var b=a.reverse(),c=B.append("g").attr("class","focus tmpc").style("display","none");c.append("circle").attr("r",4),c.append("text").attr("x",9).attr("dy",".35em");var d=B.append("g").attr("class","focus dwpc").style("display","none");d.append("circle").attr("r",4),d.append("text").attr("x",-9).attr("text-anchor","end").attr("dy",".35em");var e=B.append("g").attr("class","focus").style("display","none");e.append("text").attr("x",0).attr("text-anchor","start").attr("dy",".35em");var f=B.append("g").attr("class","focus windspeed").style("display","none");f.append("text").attr("x",0).attr("text-anchor","start").attr("dy",".35em"),z.append("rect").attr("class","overlay").attr("width",p).attr("height",q).on("mouseover",function(){c.style("display",null),d.style("display",null),e.style("display",null),f.style("display",null)}).on("mouseout",function(){c.style("display","none"),d.style("display","none"),e.style("display","none"),f.style("display","none")}).on("mousemove",function(){var a=s.invert(d3.mouse(this)[1]),i=o(b,a,1,b.length-1),j=b[i-1],k=b[i],l=a-j.press>k.press-a?k:j;c.attr("transform","translate("+(r(l.temp)+(s(h)-s(l.press))/g)+","+s(l.press)+")"),d.attr("transform","translate("+(r(l.dwpt)+(s(h)-s(l.press))/g)+","+s(l.press)+")"),e.attr("transform","translate(0,"+s(l.press)+")"),c.select("text").text(Math.round(l.temp)+"°C"),d.select("text").text(Math.round(l.dwpt)+"°C"),e.select("text").text("-- "+Math.round(l.hght)+" m"),f.attr("transform","translate("+(p-65)+","+s(l.press)+")"),f.select("text").text(Math.round(10*E(l.wspd,x))/10+" "+x)})},J=function(a){if(w=a,B.selectAll("path").remove(),C.selectAll("use").remove(),0!=w.length){var b=w.filter(function(a){return a.temp>-1e3&&a.dwpt>-1e3}),c=[];c.push(b);var d=d3.svg.line().interpolate("linear").x(function(a,b){return r(a.temp)+(s(h)-s(a.press))/g}).y(function(a,b){return s(a.press)}),f=(B.selectAll("templines").data(c).enter().append("path").attr("class",function(a,b){return b<10?"temp skline":"temp mean"}).attr("clip-path","url(#clipper)").attr("d",d),d3.svg.line().interpolate("linear").x(function(a,b){return r(a.dwpt)+(s(h)-s(a.press))/g}).y(function(a,b){return s(a.press)})),k=(B.selectAll("tempdewlines").data(c).enter().append("path").attr("class",function(a,b){return b<10?"dwpt skline":"dwpt mean"}).attr("clip-path","url(#clipper)").attr("d",f),b.filter(function(a){return a.wdir>=0&&a.wspd>=0&&a.press>=i}));C.selectAll("barbs").data(k).enter().append("use").attr("xlink:href",function(a){return"#barb"+5*Math.round(E(a.wspd,"kt")/5)}).attr("transform",function(a,b){return"translate("+p+","+s(a.press)+") rotate("+(a.wdir+180)+")"});I(c[0])}},K=function(a){B.selectAll("path").remove(),C.selectAll("use").remove(),z.append("rect").attr("class","overlay").attr("width",p).attr("height",q).on("mouseover",function(){return!1}).on("mouseout",function(){return!1}).on("mousemove",function(){return!1})};this.drawBackground=G,this.plot=J,this.clear=K,D(),F()};